
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>3.2. Creating a Python Extension &#8212; MØD 0.9.0 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="4. PostMØD (mod_post)" href="../postmod/postmod.html" />
    <link rel="prev" title="3.1.9.3. rule/Rule" href="rule/Rule.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../postmod/postmod.html" title="4. PostMØD (mod_post)"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="rule/Rule.html" title="3.1.9.3. rule/Rule"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">MØD 0.9.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="pymod.html" accesskey="U">3. PyMØD</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="creating-a-python-extension">
<span id="creatingpymodext"></span><h1>3.2. Creating a Python Extension<a class="headerlink" href="#creating-a-python-extension" title="Permalink to this headline">¶</a></h1>
<p>PyMØD is primarily Python bindings for libMØD made using
<a class="reference external" href="http://www.boost.org/libs/python/">Boost.Python</a>.
The following shows a template for creating a Python extension with C++
functions (e.g., to extend libMØD).
The complete source code for the example can be found <a class="reference external" href="../_static/examples/pymod_extension/">here</a>.</p>
<div class="section" id="library-source-and-headers">
<h2>3.2.1. Library Source and Headers<a class="headerlink" href="#library-source-and-headers" title="Permalink to this headline">¶</a></h2>
<p>For this examples the following C++ source with header should be exposed
in the Python module. Header:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifndef AWESOMELIB_HPP</span>
<span class="cp">#define AWESOMELIB_HPP</span>

<span class="cp">#include</span> <span class="cpf">&lt;mod/graph/Graph.hpp&gt;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="n">awesome</span> <span class="p">{</span>

<span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">mod</span><span class="o">::</span><span class="n">graph</span><span class="o">::</span><span class="n">Graph</span><span class="o">&gt;</span> <span class="n">doStuff</span><span class="p">();</span>

<span class="p">}</span> <span class="c1">// namespace awesome</span>

<span class="cp">#endif </span><span class="c1">// AWESOMELIB_HPP</span>
</pre></div>
</div>
<p>Source:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;stuff.hpp&quot;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="n">awesome</span> <span class="p">{</span>

<span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">mod</span><span class="o">::</span><span class="n">graph</span><span class="o">::</span><span class="n">Graph</span><span class="o">&gt;</span> <span class="n">doStuff</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">auto</span> <span class="n">g</span> <span class="o">=</span> <span class="n">mod</span><span class="o">::</span><span class="n">graph</span><span class="o">::</span><span class="n">Graph</span><span class="o">::</span><span class="n">smiles</span><span class="p">(</span><span class="s">&quot;CCO&quot;</span><span class="p">);</span>
	<span class="n">g</span><span class="o">-&gt;</span><span class="n">setName</span><span class="p">(</span><span class="s">&quot;Ethanol&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">g</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">}</span> <span class="c1">// namespace awesome</span>
</pre></div>
</div>
</div>
<div class="section" id="exposing-the-interface">
<h2>3.2.2. Exposing the Interface<a class="headerlink" href="#exposing-the-interface" title="Permalink to this headline">¶</a></h2>
<p>See the Boost.Python documentation for instructions how to expose C++ code.
Below is the code for creating our simple Python extension.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;boost/python.hpp&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&quot;stuff.hpp&quot;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;mod/Config.hpp&gt;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="n">py</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">python</span><span class="p">;</span>

<span class="k">namespace</span> <span class="p">{</span>
	<span class="c1">// this can be used to make sure the extension and mod is using the same shared library</span>
	<span class="kt">uintptr_t</span> <span class="n">magicLibraryValue</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">::</span><span class="n">getConfig</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">BOOST_PYTHON_MODULE</span><span class="p">(</span><span class="n">awesome</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">py</span><span class="o">::</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;magicLibraryValue&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">magicLibraryValue</span><span class="p">);</span>

	<span class="n">py</span><span class="o">::</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;doStuff&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">awesome</span><span class="o">::</span><span class="n">doStuff</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The example exposes a bit of extra functionality for a sanity check.
Python will <code class="docutils literal notranslate"><span class="pre">dlopen</span></code> libMØD twice As both the PyMØD module and our extension
requires it. The library uses static variables and strange things might happen
if multiple instances of these exist. The MØD wrapper script changes the dlopen
flags (setting <code class="docutils literal notranslate"><span class="pre">RTLD_GLOBAL</span></code> and <code class="docutils literal notranslate"><span class="pre">RTLD_NOW</span></code>) which should prevent multiple
instances of the library. The function <code class="docutils literal notranslate"><span class="pre">magicLibraryValue</span></code> can be used to check
that this is true (see the test script below).</p>
</div>
<div class="section" id="building-with-cmake">
<h2>3.2.3. Building With CMake<a class="headerlink" href="#building-with-cmake" title="Permalink to this headline">¶</a></h2>
<p>We can use CMake to build the example:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.10</span><span class="p">)</span>
<span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span> <span class="s">CMAKE_MODULE_PATH</span> <span class="o">${</span><span class="nv">CMAKE_CURRENT_LIST_DIR</span><span class="o">}</span><span class="s">/cmake</span><span class="p">)</span>

<span class="nb">project</span><span class="p">(</span><span class="s">PyModTestProject</span> <span class="s">CXX</span><span class="p">)</span>

<span class="c"># MØD</span>
<span class="c"># -------------------------------------------------------------------------</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">mod</span> <span class="s">REQUIRED</span><span class="p">)</span>


<span class="c"># Boost.Python</span>
<span class="c"># -------------------------------------------------------------------------</span>
<span class="nb">set</span><span class="p">(</span><span class="s">v</span> <span class="s">1.64.0</span><span class="p">)</span>
<span class="nb">foreach</span><span class="p">(</span><span class="s">PY</span> <span class="s">3</span> <span class="s">34</span> <span class="s">35</span> <span class="s">36</span> <span class="s">37</span> <span class="s">38</span> <span class="s">39</span><span class="p">)</span>
    <span class="nb">set</span><span class="p">(</span><span class="s">lib</span> <span class="s2">&quot;python${PY}&quot;</span><span class="p">)</span>
    <span class="nb">find_package</span><span class="p">(</span><span class="s">Boost</span> <span class="o">${</span><span class="nv">v</span><span class="o">}</span> <span class="s">QUIET</span> <span class="s">COMPONENTS</span> <span class="o">${</span><span class="nv">lib</span><span class="o">}</span><span class="p">)</span>
    <span class="nb">if</span><span class="p">(</span><span class="s">Boost_FOUND</span><span class="p">)</span>
        <span class="nb">find_package</span><span class="p">(</span><span class="s">Boost</span> <span class="o">${</span><span class="nv">v</span><span class="o">}</span> <span class="s">COMPONENTS</span> <span class="o">${</span><span class="nv">lib</span><span class="o">}</span><span class="p">)</span>
        <span class="nb">set</span><span class="p">(</span><span class="s">PYTHON_TARGET</span> <span class="o">${</span><span class="nv">lib</span><span class="o">}</span><span class="p">)</span>
        <span class="nb">break</span><span class="p">()</span>
    <span class="nb">endif</span><span class="p">()</span>
<span class="nb">endforeach</span><span class="p">()</span>
<span class="nb">if</span><span class="p">(</span><span class="s">NOT</span> <span class="s">Boost_FOUND</span><span class="p">)</span>
    <span class="nb">find_package</span><span class="p">(</span><span class="s">Boost</span> <span class="o">${</span><span class="nv">v</span><span class="o">}</span> <span class="s">REQUIRED</span> <span class="s">COMPONENTS</span> <span class="s">python3</span><span class="p">)</span>
    <span class="nb">message</span><span class="p">(</span><span class="s">FATAL_ERROR</span> <span class="s2">&quot;Could not find Boost.Python for Python 3. Tried &#39;python&#39; wih suffixes 3, 34, 35, 36, 37, 38, and 39.&quot;</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>


<span class="c"># Python 3</span>
<span class="c"># -------------------------------------------------------------------------</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">Python3</span> <span class="s">REQUIRED</span> <span class="s">COMPONENTS</span> <span class="s">Interpreter</span> <span class="s">Development</span><span class="p">)</span>


<span class="c"># Artefacts</span>
<span class="c"># -------------------------------------------------------------------------</span>

<span class="nb">add_library</span><span class="p">(</span><span class="s">awesome</span> <span class="s">MODULE</span>
        <span class="s">pyModule.cpp</span>
        <span class="s">stuff.cpp</span><span class="p">)</span>
<span class="nb">set_target_properties</span><span class="p">(</span><span class="s">awesome</span> <span class="s">PROPERTIES</span> <span class="s">PREFIX</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="c"># so it doesn&#39;t get the &quot;lib&quot; prefix</span>
<span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">awesome</span> <span class="s">PUBLIC</span> <span class="s">mod::libmod</span> <span class="s">Boost::</span><span class="o">${</span><span class="nv">PYTHON_TARGET</span><span class="o">}</span> <span class="s">Python3::Python</span><span class="p">)</span>
<span class="nb">target_compile_options</span><span class="p">(</span><span class="s">awesome</span> <span class="s">PRIVATE</span> <span class="s">-Wall</span> <span class="s">-Wextra</span>
        <span class="s">-Wno-unused-parameter</span>
        <span class="s">-Wno-comment</span>
        <span class="s">-Wno-unused-local-typedefs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="testing-the-extension">
<h2>3.2.4. Testing the Extension<a class="headerlink" href="#testing-the-extension" title="Permalink to this headline">¶</a></h2>
<p>After configuring and building there should be a shared library <code class="docutils literal notranslate"><span class="pre">awesome.so</span></code> which contains
the extension. Executing the following script using the wrapper script in the same folder
as the shared libray should now work:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">awesome</span>

<span class="c1"># sanity check for multiple copies of libMØD</span>
<span class="n">modValue</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">magicLibraryValue</span><span class="p">()</span>
<span class="n">ourValue</span> <span class="o">=</span> <span class="n">awesome</span><span class="o">.</span><span class="n">magicLibraryValue</span><span class="p">()</span>
<span class="k">if</span> <span class="n">modValue</span> <span class="o">!=</span> <span class="n">ourValue</span><span class="p">:</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">&quot;mod =&quot;</span><span class="p">,</span> <span class="n">modValue</span><span class="p">)</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">&quot;our =&quot;</span><span class="p">,</span> <span class="n">ourValue</span><span class="p">)</span>
	<span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Magic values differ! I.e., more than one instance of libMØD has been loaded.&quot;</span><span class="p">)</span>
<span class="c1"># end if check</span>

<span class="n">g</span> <span class="o">=</span> <span class="n">awesome</span><span class="o">.</span><span class="n">doStuff</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;Got a graph:&quot;</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="k">print</span><span class="p">()</span>
</pre></div>
</div>
<p>Command to execute:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mod -f test.py
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">3.2. Creating a Python Extension</a><ul>
<li><a class="reference internal" href="#library-source-and-headers">3.2.1. Library Source and Headers</a></li>
<li><a class="reference internal" href="#exposing-the-interface">3.2.2. Exposing the Interface</a></li>
<li><a class="reference internal" href="#building-with-cmake">3.2.3. Building With CMake</a></li>
<li><a class="reference internal" href="#testing-the-extension">3.2.4. Testing the Extension</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="rule/Rule.html"
                        title="previous chapter">3.1.9.3. rule/Rule</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../postmod/postmod.html"
                        title="next chapter">4. PostMØD (<code class="docutils literal notranslate"><span class="pre">mod_post</span></code>)</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/pymod/extensions.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../postmod/postmod.html" title="4. PostMØD (mod_post)"
             >next</a> |</li>
        <li class="right" >
          <a href="rule/Rule.html" title="3.1.9.3. rule/Rule"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">MØD 0.9.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="pymod.html" >3. PyMØD</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2013-2018, Jakob Lykke Andersen.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.1.3+/83a3b7a8.
    </div>
  </body>
</html>